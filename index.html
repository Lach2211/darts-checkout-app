<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#111" />
  <link rel="manifest" href="manifest.webmanifest" />
  <title>Darts Checkout Rechner</title>
  <style>
    /* Reset & Full-bleed */
    *, *::before, *::after { box-sizing: border-box; }
    html, body { height: 100%; }
    html { -webkit-text-size-adjust: 100%; }
    body {
      margin: 0;
      min-height: 100svh; /* mobile-safe viewport height */
      width: 100%;
      background: #0f0f13;
      color: #fff;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      display: flex;
    }
    /* App root: volle Breite */
    #app {
      flex: 1 1 auto;
      min-height: 100%;
      width: 100%;
      max-width: none;   /* wichtig: keine fixe max-width */
      margin: 0;         /* keine Auto-Zentrierung */
      padding: 12px;
      display: grid;
      grid-template-rows: auto auto 1fr;
      gap: 12px;
    }

    /* Beispiel: Scrollbares Raster für Scores – immer volle Breite */
    .score-grid {
      width: 100%;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(64px, 1fr));
      gap: 8px;
      overflow: auto;
      padding-bottom: 8px;
    }
    .score-btn {
      display: grid;
      place-items: center;
      border: 1px solid #2a2a34;
      border-radius: 10px;
      padding: 10px 0;
      background: #14141b;
      font-weight: 600;
      user-select: none;
      cursor: pointer;
    }
    .score-btn.min3 {
      outline: 2px solid #b30000;     /* rote Kontur */
      background: #171217;            /* dunkler */
    }

    /* Lieblings-Doppel Buttons */
    .fav-doubles { display: flex; flex-wrap: wrap; gap: 8px; }
    .fav-btn {
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid #2a2a34;
      background:#121217;
      cursor:pointer;
    }
    .fav-btn.active { outline: 2px solid #6cf; }

    /* Top-3 + Ausklappbereich */
    .results { width: 100%; }
    .top3 { display: grid; gap: 6px; }
    details.more { margin-top: 10px; }
    summary { cursor: pointer; }
  </style>
</head>
<body>
  <main id="app">
    <header><h1 style="margin:0;font-size:1.25rem;">Darts Checkout Rechner</h1></header>

    <!-- Moduswahl -->
    <section class="modes" role="group" aria-label="Modus">
      <button data-mode="DO">Double Out</button>
      <button data-mode="MO">Master Out</button>
      <button data-mode="SO">Straight Out</button>
    </section>

    <!-- Lieblings-Doppel -->
    <section>
      <div class="fav-doubles" id="favRow"></div>
      <div style="margin-top:8px;">
        <button id="resetFavs">Auswahl zurücksetzen</button>
      </div>
    </section>

    <!-- Score-Gitter -->
    <section class="score-grid" id="scoreGrid" aria-label="Scores"></section>

    <!-- Resultate -->
    <section class="results">
      <div class="top3" id="top3"></div>
      <details class="more" id="moreWrap">
        <summary>Weitere Checkouts anzeigen</summary>
        <div id="moreList" style="margin-top:8px;display:grid;gap:6px;"></div>
      </details>
    </section>
  </main>

  <script>
    // --- PWA Service Worker registrieren ---
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').catch(console.error);
      });
    }

    // --- Modus/Regeln ---
    const MODES = {
      DO: { min: 2, max: 170, hideBogey: true, highlightFrom: 61 },
      MO: { min: 2, max: 180, hideBogey: false, highlightFrom: 61 },
      SO: { min: 2, max: 180, hideBogey: false, highlightFrom: 61 },
    };
    let currentMode = 'DO';

    // Bogey-Zahlen für DO (nicht checkbar) – klassisch
    const BOGEYS_DO = new Set([169, 168, 166, 165, 163, 162, 159]);

    // Lieblings-Doppel Handling (max 3, inkl. D25)
    const ALL_DOUBLES = ['D20','D19','D18','D17','D16','D15','D14','D13','D12','D11','D10','D9','D8','D7','D6','D5','D4','D3','D2','D1','D25'];
    const favKey = 'favDoubles';
    let favDoubles = JSON.parse(localStorage.getItem(favKey) || '[]');

    const favRow = document.getElementById('favRow');
    const resetFavsBtn = document.getElementById('resetFavs');
    const scoreGrid = document.getElementById('scoreGrid');
    const top3 = document.getElementById('top3');
    const moreWrap = document.getElementById('moreWrap');
    const moreList = document.getElementById('moreList');

    // UI bauen
    function renderFavButtons() {
      favRow.innerHTML = '';
      ALL_DOUBLES.forEach(d => {
        const b = document.createElement('button');
        b.className = 'fav-btn' + (favDoubles.includes(d) ? ' active' : '');
        b.textContent = d;
        b.onclick = () => {
          if (favDoubles.includes(d)) {
            favDoubles = favDoubles.filter(x => x !== d);
          } else {
            if (favDoubles.length < 3) favDoubles.push(d);
          }
          localStorage.setItem(favKey, JSON.stringify(favDoubles));
          renderFavButtons();
          // Ergebnisse neu sortieren, wenn offen
          // (optional: neu berechnen, wenn gerade ein Score aktiv ist)
        };
        favRow.appendChild(b);
      });
    }

    function buildScores() {
      const { min, max, hideBogey, highlightFrom } = MODES[currentMode];
      scoreGrid.innerHTML = '';
      for (let s = max; s >= min; s--) {
        if (currentMode === 'DO' && hideBogey && BOGEYS_DO.has(s)) continue;
        const btn = document.createElement('button');
        btn.className = 'score-btn' + (s >= highlightFrom ? ' min3' : '');
        btn.textContent = s;
        btn.setAttribute('data-score', s);
        btn.onclick = () => showCheckouts(s);
        scoreGrid.appendChild(btn);
      }
    }

    // Dummy-Checkout-Berechnung (Platzhalter):
    // -> Hier deine echte Logik einhängen und am Ende nach favDoubles priorisieren.
    function computeCheckouts(score) {
      // Beispielplatzhalter: gibt 1–6 fiktive Wege zurück
      const fake = [
        `T20 T20 D${(score % 20) + 1}`,
        `T19 T14 D${(score % 20) + 1}`,
        `T18 T18 D${(score % 20) + 1}`,
        `T20 ${score-60}-? D?`,
        `Bull D${(score % 20) + 1}`,
        `T17 T16 D${(score % 20) + 1}`,
      ];
      // Favorisierte Doppel priorisieren (nur DO):
      if (currentMode === 'DO' && favDoubles.length) {
        fake.sort((a, b) => {
          const pa = favDoubles.findIndex(fd => a.endsWith(fd));
          const pb = favDoubles.findIndex(fd => b.endsWith(fd));
          return (pa === -1 ? 999 : pa) - (pb === -1 ? 999 : pb);
        });
      }
      return fake;
    }

    function showCheckouts(score) {
      const list = computeCheckouts(score);
      top3.innerHTML = '';
      moreList.innerHTML = '';
      if (!list.length) { moreWrap.open = false; return; }
      // Top 3 kompakt
      list.slice(0,3).forEach((line, i) => {
        const div = document.createElement('div');
        div.textContent = (i === 0 ? '⭐ ' : '') + line;
        top3.appendChild(div);
      });
      // Rest ausklappbar
      const rest = list.slice(3);
      if (rest.length) {
        moreList.innerHTML = '';
        rest.forEach(line => {
          const div = document.createElement('div');
          div.textContent = line;
          moreList.appendChild(div);
        });
        moreWrap.open = false;
        moreWrap.style.display = '';
      } else {
        moreWrap.style.display = 'none';
      }
    }

    // Modus Buttons (einfach gehalten)
    document.querySelectorAll('[data-mode]').forEach(btn => {
      btn.onclick = () => {
        currentMode = btn.dataset.mode;
        buildScores();
      };
    });

    // Init
    renderFavButtons();
    buildScores();
  </script>
</body>
</html>
